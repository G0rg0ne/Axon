# Caddyfile - Reverse Proxy Configuration
# Domain: axon-agent.online

{
    # Global options
    email ghost.beta.tester7@gmail.com  # Required for Let's Encrypt notifications
}

# Main domain - serves the Streamlit frontend
axon-agent.online {
    # Enable compression
    encode gzip zstd

    # Reverse proxy to Streamlit frontend
    reverse_proxy frontend:8501

    # Handle Streamlit WebSocket connections
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @websockets frontend:8501

    # Logging
    log {
        output file /data/access.log
        format console
    }
}

# www redirect to main domain
www.axon-agent.online {
    redir https://axon-agent.online{uri} permanent
}

# API subdomain - serves the FastAPI backend
api.axon-agent.online {
    # Enable compression
    encode gzip zstd

    # Reverse proxy to FastAPI backend
    reverse_proxy backend:8000

    # CORS headers (restricted to main domain)
    header {
        Access-Control-Allow-Origin https://axon-agent.online
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
        Access-Control-Allow-Credentials true
    }

    # Logging
    log {
        output file /data/api-access.log
        format console
    }
}

# Status page subdomain - Uptime Kuma monitoring
status.axon-agent.online {
    # Enable compression
    encode gzip zstd

    # Reverse proxy to Uptime Kuma
    reverse_proxy uptime-kuma:3001

    # Handle WebSocket connections (required for real-time updates)
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @websockets uptime-kuma:3001

    # Logging
    log {
        output file /data/status-access.log
        format console
    }
}
